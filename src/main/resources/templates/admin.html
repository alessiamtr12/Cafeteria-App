<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Cafeteria</title>
  <link rel="stylesheet" th:href="@{/style.css}" />
</head>
<body>
<div class="navbar">
  <a href="/" class="login-link">‚Üê Back to Store</a>
</div>

<div class="header">
  <h1>Admin Panel</h1>
  <p>Manage the menu via RMI bridge</p>
</div>

<div class="container">
  <div class="menu-grid">
    <div class="card" style="padding: 20px;">
      <h3>Add New Dish</h3>
      <input id="name" class="input-field" placeholder="Name" />
      <input id="description" class="input-field" placeholder="Description" />
      <input id="price" class="input-field" placeholder="Price" type="number" step="0.01" />
      <button class="btn" onclick="submitDish()">Create Dish</button>
    </div>

    <div class="card" style="padding: 20px;">
      <h3>Create Menu Bundle</h3>
      <input id="menuName" class="input-field" placeholder="Menu Name" />
      <select id="menuComponents" multiple size="5" class="input-field" style="height: 100px;">
        <option th:each="o : ${options}" th:value="${o.id}"
                th:text="'[' + ${o.type} + '] ' + ${o.name}"></option>
      </select>
      <button class="btn" onclick="submitMenu()">Create Menu</button>
    </div>
  </div>

  <hr style="margin: 40px 0; border: 1px solid #eee;">

  <h2>Existing Items</h2>
  <div class="menu-grid">
    <div th:each="d : ${dishes}" class="card" th:id="'dish-' + ${d.id}">
      <div class="card-content">
        <h3 th:text="${d.name}"></h3>
        <p th:text="'ID: ' + ${d.id}"></p>
        <div class="price-tag" th:text="'$' + ${#numbers.formatDecimal(d.price, 1, 2)}"></div>
          <button class="btn" style="background: #e74c3c"
                  th:onclick="'deleteDish(' + ${d.id} + ')'">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
  async function submitDish() {
    const payload = {
      name: document.getElementById("name").value,
      description: document.getElementById("description").value,
      price: Number(document.getElementById("price").value)
    };
    await fetch("/admin/api/dishes", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    location.reload();
  }

  async function submitMenu() {
    const select = document.getElementById("menuComponents");
    const payload = {
      name: document.getElementById("menuName").value,
      componentIds: Array.from(select.selectedOptions).map(o => Number(o.value))
    };
    await fetch("/admin/api/menus", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    location.reload();
  }

  async function deleteDish(dishId) {
      const ok = confirm(`Are you sure?`);
      if (!ok) return;

      const res = await fetch(`/admin/api/dishes/${dishId}`, { method: 'DELETE' });

      if (res.ok) {
          showPopup("Dish deleted.");
          window.location.reload();
          return;
      }

      if (res.status === 409) {
          const msg = await res.text();
          showPopup(msg);
          return;
      }

      showPopup("Delete failed (unexpected error).");
  }

  function showPopup(message) {
      alert(message);
  }
</script>
</body>
</html>